#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="/home/pi-collector/edge_data_processor/video_gather/record_video.py"
SERVICE_FILE="/etc/systemd/system/record-video.service"
SERVICE_BODY="[Unit]\nDescription=Record 30s Video on Boot\nAfter=multi-user.target\n\n[Service]\nType=oneshot\nUser=pi-collector\nExecStart=/usr/bin/python3 /home/pi-collector/edge_data_processor/video_gather/record_video.py --duration 30\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n"

sudo chmod +x "$SCRIPT_PATH"

temp_file=$(mktemp)
printf '%s' "$SERVICE_BODY" > "$temp_file"

if ! sudo test -f "$SERVICE_FILE" || ! sudo cmp -s "$temp_file" "$SERVICE_FILE"; then
    echo "Updating systemd service definition at $SERVICE_FILE"
    sudo cp "$temp_file" "$SERVICE_FILE"
else
    echo "Systemd service already up to date."
fi
rm -f "$temp_file"

sudo systemctl daemon-reload
sudo systemctl enable record-video.service
sudo reboot
